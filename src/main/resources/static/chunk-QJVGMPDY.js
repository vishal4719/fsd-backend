import{j as l,k as p,r as g}from"./chunk-YLNKWVWQ.js";import{I as i,L as h,Q as n,i as r,m as o,w as s}from"./chunk-L5ZCWPZT.js";var c=class a{constructor(e,t){this.http=e;this.router=t;this.authState.next(this.isLoggedIn()),this.isLoggedIn()&&this.getDashboard().subscribe()}apiUrl="198.96.89.132:8080/registration/api";tokenKey="auth_token";userRoleKey="user_role";isAuthenticatedSubject=new r(this.hasValidToken());authState=new r(!1);userData=new r(null);get isAuthenticated$(){return this.authState.asObservable()}get userData$(){return this.userData.asObservable()}signup(e){return console.log("Sending signup request:",e),this.http.post(`${this.apiUrl}/auth/signup`,e,{headers:this.getHeaders()}).pipe(i(t=>console.log("Signup response:",t)),s(this.handleError.bind(this)))}login(e){return console.log("Sending login request:",e),this.http.post(`${this.apiUrl}/auth/login`,e,{headers:this.getHeaders()}).pipe(i(t=>{if(!t?.token||!t?.role)throw new Error("Invalid response from server");this.setToken(t.token),this.setUserRole(t.role),this.isAuthenticatedSubject.next(!0),this.authState.next(!0),this.handleLoginSuccess(t)}),s(this.handleError.bind(this)))}handleLoginSuccess(e){e.role==="USER"?this.checkParticipationStatus().subscribe({next:t=>{t.hasSubmittedForm?this.router.navigate(["/dashboard"]):this.router.navigate(["/participation"])},error:()=>{this.router.navigate(["/dashboard"])}}):this.router.navigate(["/dashboard"])}checkParticipationStatus(){return this.http.get(`${this.apiUrl}/participation/status`,{headers:this.getAuthHeaders()})}getDashboard(){let e=localStorage.getItem(this.userRoleKey);if(!e)return o(()=>new Error("No role found"));let t=e.toLowerCase().replace("_","-");return this.http.get(`${this.apiUrl}/roles/${t}`,{headers:this.getAuthHeaders()}).pipe(i(u=>{this.userData.next({email:u.username,username:u.username})}),s(this.handleError))}logout(){localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.userRoleKey),this.isAuthenticatedSubject.next(!1),this.authState.next(!1),this.userData.next(null),this.router.navigate(["/login"])}isLoggedIn(){return!!localStorage.getItem(this.tokenKey)}getToken(){return localStorage.getItem(this.tokenKey)}getUserRole(){return localStorage.getItem(this.userRoleKey)}setToken(e){localStorage.setItem(this.tokenKey,e)}setUserRole(e){localStorage.setItem(this.userRoleKey,e)}getAuthHeaders(){let e=this.getToken();return new l({"Content-Type":"application/json",Authorization:`Bearer ${e}`})}getHeaders(){return new l({"Content-Type":"application/json"})}handleError(e){console.error("API Error:",e);let t="An error occurred";return e.error instanceof ErrorEvent?t=e.error.message:e.status===400?t=e.error?.message||"Invalid request data":e.status===401?(t="Invalid credentials",this.logout()):e.status===403?t="Access denied":t=e.error?.message||`Error: ${e.status} - ${e.statusText}`,o(()=>new Error(t))}hasValidToken(){return!!this.getToken()}static \u0275fac=function(t){return new(t||a)(n(p),n(g))};static \u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})};export{c as a};
